# Helix AI Gateway Redis Configuration
# Optimized for high-performance caching and vector search with RediSearch

# Network settings
bind 0.0.0.0
port 6379
protected-mode no

# General settings
daemonize no
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile ""

# Database settings
databases 16

# Snapshotting (RDB)
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# Append Only File (AOF)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Memory management
maxmemory 2gb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Redis Modules (Redis Stack)
# Load RediSearch for vector search and text indexing
loadmodule /opt/redis-stack/lib/redisearch.so

# Load RedisJSON for JSON document storage
loadmodule /opt/redis-stack/lib/rejson.so

# Load RedisTimeSeries for time-series data
loadmodule /opt/redis-stack/lib/redistimeseries.so

# Load RedisBloom for probabilistic data structures
loadmodule /opt/redis-stack/lib/redisbloom.so

# Load RedisGraph for graph operations (if needed)
# loadmodule /opt/redis-stack/lib/redisgraph.so

# RediSearch Configuration
# Maximum search results
ft.maxsearchresults 10000

# Maximum number of concurrent searches
ft.maxconcurrentsearches 50

# Timeout for search operations (in ms)
ft.searchtimeout 5000

# Suggestion settings for autocomplete
ft.suggestionmaxlen 200
ft.suggestioncount 20

# Index creation parameters
# FT.CREATE helix:semantic:index ON HASH PREFIX 1 "helix:vector:" SCHEMA
#   prompt TEXT
#   model TEXT
#   response_json TEXT
#   vector VECTOR HNSW 12 DIM 384 DISTANCE_METRIC COSINE TYPE FLOAT32
#   cost FLOAT
#   latency FLOAT
#   created_at TEXT

# HNSW (Hierarchical Navigable Small World) parameters for vector search
# These can be fine-tuned based on your dataset size and performance requirements
# M: Number of bi-directional links created for each new element (affects recall and memory)
# ef_construction: Size of the dynamic candidate list for constructing the graph
# ef_runtime: Size of the dynamic candidate list for search (affects speed vs accuracy)

# Vector search index optimization
# For better recall at the cost of memory:
# M = 32, ef_construction = 400, ef_runtime = 100

# For better speed at the cost of recall:
# M = 8, ef_construction = 100, ef_runtime = 32

# Balance settings (good default for most use cases):
# M = 16, ef_construction = 200, ef_runtime = 50

# Persistence settings
# Save RDB snapshots every 5 minutes if at least 100 keys changed
save 300 100

# AOF rewrite settings
aof-rewrite-incremental-fsync yes

# Client settings
timeout 0
tcp-keepalive 300
tcp-backlog 511

# Slow log
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100

# Event notification (Redis keyspace notifications)
notify-keyspace-events "Ex"

# Advanced settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing (background rehashing of hash tables)
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limits
client-query-buffer-limit 1gb

# Protocol max bulk request size
proto-max-bulk-len 512mb

# HZ frequency (frequency of background tasks)
hz 10

# Dynamic HZ
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

# Security settings (uncomment and configure for production)
# requirepass your_redis_password
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG "CONFIG_b835c3f8a5d2e7n4"

# Replication settings (if using Redis cluster or replication)
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-diskless-load disabled
# repl-ping-replica-period 10
# repl-timeout 60
# repl-disable-tcp-nodelay no
# repl-backlog-size 1mb
# repl-backlog-ttl 3600

# Sentinel settings (if using Redis Sentinel)
# sentinel announce-ip <your-ip>
# sentinel announce-port <your-port>

# Cluster settings (if using Redis Cluster)
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-announce-ip <your-ip>
# cluster-announce-port <your-port>
# cluster-announce-bus-port <your-bus-port>

# Memory optimization for Helix workloads
# Increase hash table size for better performance with many keys
hash-max-ziplist-entries 1024

# Optimize for caching workloads
# These settings help with the mixed read/write workload of Helix
# where we have many small cached responses and occasional large vectors

# Set appropriate eviction policy for cache-heavy workloads
# allkeys-lru: Evict any key using least recently used algorithm
# volatile-lru: Evict only keys with an expiration set
# allkeys-lfu: Evict any key using least frequently used algorithm
# volatile-lfu: Evict only keys with an expiration set
# maxmemory-policy allkeys-lru

# Set reasonable timeout for idle connections
timeout 300

# Enable TCP keepalive
tcp-keepalive 60

# Set appropriate backlog for connection handling
tcp-backlog 1024

# Optimize for network performance
# These settings help with high-throughput scenarios
# where many small requests are processed

# Disable nagle algorithm for lower latency
tcp-nodelay yes

# Enable keepalive for connection reuse
tcp-keepalive yes

# Logging configuration
# Use notice level for production to balance detail and performance
loglevel notice

# Log to stdout for container environments
logfile ""

# Syslog configuration (if using syslog)
# syslog-enabled yes
# syslog-ident redis

# Performance monitoring
# Enable latency monitoring to track slow operations
latency-monitor-threshold 100

# Enable slow query log for debugging
slowlog-log-slower-than 10000
slowlog-max-len 256

# Client configuration
# Set appropriate limits for client connections
maxclients 10000

# Set query buffer limits for large payloads
client-query-buffer-limit 512mb

# Set protocol limits for large cached responses
proto-max-bulk-len 512mb

# Background task configuration
# Set appropriate frequency for background tasks
hz 10

# Enable dynamic HZ for better power efficiency
dynamic-hz yes

# Persistence tuning for Helix workloads
# Adjust RDB save strategy for cache workloads
# More frequent saves with fewer key changes for better durability
save 60 1000
save 300 100
save 900 1

# Optimize AOF for cache workloads
# Append fsync every second for good balance of performance and durability
appendfsync everysec

# Enable incremental AOF rewrite for better performance
aof-rewrite-incremental-fsync yes

# Enable RDB incremental fsync for better performance
rdb-save-incremental-fsync yes

# Memory optimizations for Helix
# Adjust data structure encoding thresholds for cache workloads
hash-max-ziplist-entries 1024
hash-max-ziplist-value 128
list-max-ziplist-size -3
set-max-intset-entries 1024
zset-max-ziplist-entries 256
zset-max-ziplist-value 128

# Configure HyperLogLog for cardinality estimation
hll-sparse-max-bytes 3000

# Configure stream data structures for real-time metrics
stream-node-max-bytes 4096
stream-node-max-entries 100

# Security and compliance
# Uncomment and configure these for production deployments
# requirepass your-secure-password-here
# rename-command DEBUG ""
# rename-command EVAL ""
# rename-command CONFIG ""
# rename-command SHUTDOWN ""
# rename-command FLUSHALL ""
# rename-command FLUSHDB ""

# Monitoring and observability
# Enable stats collection for monitoring
stat-enabled yes

# Enable command stats for detailed monitoring
command-stats-enabled yes

# Enable CPU usage tracking
enable-protected-configs yes

# Enable memory usage tracking
enable-debug-command yes

# Health checks
# Set up appropriate health check endpoints
# This is useful for container orchestration systems
# like Kubernetes or Docker Swarm